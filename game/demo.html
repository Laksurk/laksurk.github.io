<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Ably 配对 Demo（6 位 key）</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<style>
		body{font-family:Arial,Helvetica,sans-serif;padding:16px}
		input,button{margin:6px;padding:6px}
		#events{height:220px;overflow:auto;background:#f6f6f6;border:1px solid #ddd;padding:8px}
	</style>
	<!-- Ably 客户端 -->
	<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
	<h1>Ably 最小配对 Demo（6 位 key）</h1>
	<p>替代 Firebase：使用 Ably Realtime 的 presence + publish/subscribe（成本低，快速接入）。</p>

	<div>
		<label>6位房间 Key：<input id="keyInput" maxlength="6" placeholder="例如 ABC123"></label>
		<button id="joinBtn">加入/创建房间</button>
	</div>
	<div id="status">状态：未加入</div>

	<h3>事件（简易演示）</h3>
	<div id="events"></div>
	<div>
		<input id="msgInput" placeholder="输入事件文本">
		<button id="sendBtn" disabled>发送事件</button>
	</div>

	<script>
	// --- 请替换为你的 Ably API Key（测试阶段可直接放前端） ---
	const ABLY_API_KEY = 'rDsQmg.uUBjAg:p_l0CknGiH99DMQvioK4Ch2nZrKf9JUG2Kn6g8Sbou4';
	// -------------------------------------------------------

	const keyInput = document.getElementById('keyInput');
	const joinBtn = document.getElementById('joinBtn');
	const statusEl = document.getElementById('status');
	const eventsEl = document.getElementById('events');
	const msgInput = document.getElementById('msgInput');
	const sendBtn = document.getElementById('sendBtn');

	const clientId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2,9);
	let roomKey = null;
	let ably, channel;

	function appendEvent(text){
		const d = document.createElement('div'); d.textContent = text; eventsEl.appendChild(d); eventsEl.scrollTop = eventsEl.scrollHeight;
	}

	joinBtn.onclick = async ()=>{
		const k = (keyInput.value || '').trim().toUpperCase();
		if(!/^[A-Z0-9]{6}$/.test(k)) { alert('请输入 6 位 (A-Z,0-9) 的 Key'); return; }
		roomKey = k;
		joinBtn.disabled = true; keyInput.disabled = true;
		statusEl.textContent = '状态：尝试加入 ' + roomKey;

		// 初始化 Ably
		try{
			ably = new Ably.Realtime(ABLY_API_KEY);
		}catch(e){
			alert('初始化 Ably 失败，请检查 API Key');
			console.error(e); return;
		}

		channel = ably.channels.get('room:' + roomKey);

		// Presence: 进入
		channel.presence.enter({clientId: clientId, ts: Date.now()});

		// 订阅 presence 变化
		channel.presence.subscribe('enter', (m)=>{
			appendEvent('玩家加入: ' + (m.data && m.data.clientId));
			updatePlayersCount();
		});
		channel.presence.subscribe('leave', (m)=>{
			appendEvent('玩家离开: ' + (m.data && m.data.clientId));
			updatePlayersCount();
		});

		// 订阅游戏事件
		channel.subscribe('gameEvent', msg => {
			const d = msg.data || {};
			appendEvent((d.from===clientId? '我: ' : (d.from||'对手')+': ') + d.msg + ' (' + new Date(d.ts).toLocaleTimeString() + ')');
		});

		// 获取当前 presence 列表并更新状态
		updatePlayersCount();
		appendEvent('已加入房间 ' + roomKey + '，你的 id: ' + clientId);
		statusEl.textContent = '状态：已加入 ' + roomKey + '，等待匹配';
	};

	function updatePlayersCount(){
		channel.presence.get((err, members) => {
			if(err){ console.warn('presence.get err', err); return; }
			const n = members.length;
			statusEl.textContent = '状态：房间 ' + roomKey + '，玩家数 ' + n;
			if(n >= 2){
				appendEvent('匹配完成：两台电脑已准备。开始游戏。');
				sendBtn.disabled = false;
			} else {
				sendBtn.disabled = true;
			}
		});
	}

	sendBtn.onclick = ()=>{
		const text = (msgInput.value||'').trim(); if(!text) return;
		const e = {from: clientId, msg: text, ts: Date.now()};
		channel.publish('gameEvent', e);
		msgInput.value = '';
	};

	// 离开页面时退出 presence
	window.addEventListener('beforeunload', ()=>{
		try{ if(channel) channel.presence.leave(); }catch(e){}
	});
	</script>

	<p style="margin-top:18px;color:#666">使用说明：在 Ably 控制台创建免费账号并生成 API Key（Dashboard → API keys），把 key 填到上面的 `ABLY_API_KEY`。生产请使用 token auth。</p>
</body>
</html>

