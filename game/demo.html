<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>配对 Demo（6 位 key）</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<style>
		body{font-family:Arial,Helvetica,sans-serif;padding:16px}
		input,button{margin:6px;padding:6px}
		#events{height:220px;overflow:auto;background:#f6f6f6;border:1px solid #ddd;padding:8px}
	</style>
	<!-- Firebase compat SDK（用于快速演示） -->
	<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
	<h1>GitHub Pages + Firebase 最小配对 Demo</h1>
	<p>成本最低的配对方式：使用 Firebase Realtime Database（免费额度足够测试）。</p>

	<div>
		<label>6位房间 Key：<input id="keyInput" maxlength="6" placeholder="例如 ABC123"></label>
		<button id="joinBtn">加入/创建房间</button>
	</div>
	<div id="status">状态：未加入</div>

	<h3>事件（简易演示）</h3>
	<div id="events"></div>
	<div>
		<input id="msgInput" placeholder="输入事件文本">
		<button id="sendBtn" disabled>发送事件</button>
	</div>

	<script>
	// --- 请替换为你自己的 Firebase 配置（在 Firebase 控制台获得） ---
	const firebaseConfig = {
		apiKey: "YOUR_API_KEY",
		authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
		databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
		projectId: "YOUR_PROJECT_ID",
		storageBucket: "YOUR_PROJECT_ID.appspot.com",
		messagingSenderId: "...",
		appId: "..."
	};
	// -------------------------------------------------------------

	firebase.initializeApp(firebaseConfig);
	const db = firebase.database();

	const keyInput = document.getElementById('keyInput');
	const joinBtn = document.getElementById('joinBtn');
	const statusEl = document.getElementById('status');
	const eventsEl = document.getElementById('events');
	const msgInput = document.getElementById('msgInput');
	const sendBtn = document.getElementById('sendBtn');

	const clientId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2,9);
	let roomKey = null;
	let playersRef, eventsRef, playersListener, eventsListener;

	function appendEvent(text){
		const d = document.createElement('div'); d.textContent = text; eventsEl.appendChild(d); eventsEl.scrollTop = eventsEl.scrollHeight;
	}

	joinBtn.onclick = async ()=>{
		const k = (keyInput.value || '').trim().toUpperCase();
		if(!/^[A-Z0-9]{6}$/.test(k)) { alert('请输入 6 位 (A-Z,0-9) 的 Key'); return; }
		roomKey = k;
		joinBtn.disabled = true; keyInput.disabled = true;
		statusEl.textContent = '状态：尝试加入 ' + roomKey;

		playersRef = db.ref('rooms/' + roomKey + '/players');
		eventsRef = db.ref('rooms/' + roomKey + '/events');

		// 注册 presence：加入时写入自己的 id，断线时删除
		const myRef = db.ref('rooms/' + roomKey + '/players/' + clientId);
		await myRef.set({id: clientId, ts: Date.now()});
		myRef.onDisconnect().remove();

		// 监听玩家列表
		playersListener = playersRef.on('value', snapshot => {
			const obj = snapshot.val() || {};
			const ids = Object.keys(obj);
			statusEl.textContent = '状态：房间 ' + roomKey + '，玩家数 ' + ids.length;
			if(ids.length === 2){
				appendEvent('匹配完成：两台电脑已准备。开始游戏。');
				sendBtn.disabled = false;
			} else if(ids.length > 2){
				appendEvent('房间人数已超过 2（当前 ' + ids.length + '），第三人只作为旁观者');
				sendBtn.disabled = false;
			} else {
				appendEvent('等待另一名玩家加入...');
				sendBtn.disabled = true;
			}
		});

		// 监听事件（其他客户端 push 的游戏事件）
		eventsListener = eventsRef.limitToLast(50).on('child_added', snap => {
			const v = snap.val();
			appendEvent((v.from===clientId? '我: ' : (v.from||'对手')+': ') + v.msg + ' (' + new Date(v.ts).toLocaleTimeString() + ')');
		});

		appendEvent('已加入房间 ' + roomKey + '，你的 id: ' + clientId);
		statusEl.textContent = '状态：已加入 ' + roomKey + '，等待匹配';
	};

	sendBtn.onclick = async ()=>{
		const text = (msgInput.value||'').trim(); if(!text) return;
		const e = {from: clientId, msg: text, ts: Date.now()};
		await eventsRef.push(e);
		msgInput.value = '';
	};

	// 离开页面时清理
	window.addEventListener('beforeunload', ()=>{
		if(roomKey){
			try{ db.ref('rooms/' + roomKey + '/players/' + clientId).remove(); }catch(e){}
		}
	});
	</script>

	<p style="margin-top:18px;color:#666">使用说明：在 Firebase 控制台创建项目并启用 Realtime Database，复制你的 firebaseConfig 到上面代码位置。数据库测试阶段可以设为公开读写（生产请设置规则和认证）。</p>
</body>
</html>

