<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8" />
<title>电路绘制工具</title>
<script src="../src/jquery.min.js"></script>
<script>

const n=10, side=120, square=50, menu=180, m=4;
var mode=0;

function encodeCKT(){
    var obj={};
    $(".board").each(function(idx){
        if($(this).text()!="")
            obj[idx]=Number($(this).text());
    });
    return JSON.stringify(obj);
}
function decodeCKT(str){
    var obj=JSON.parse(str);
    var _mode=mode;
    $(".board").each(function(idx){
        if(idx in obj){
            $(".side").eq(obj[idx]).click();
            $(this).click();
        }
    });
    $(".side").eq(_mode).click();
}
function paint(canvas, type){
    const unit=square>>1;
    const ctx=canvas.getContext("2d");
    ctx.scale(unit, -unit);
    ctx.translate(1, -1);
    ctx.lineWidth=2/unit;
    ctx.strokeStyle="black";
    const func={
        line: function(){
            ctx.moveTo(-1, 0);
            ctx.lineTo(1, 0);
        },
        bulb: function(){
            const x=Math.sqrt(1/2);
            ctx.arc(0, 0, 0.97, 0, Math.PI*2);
            ctx.fillStyle="white";
            ctx.fill();
            ctx.moveTo(-x, -x);
            ctx.lineTo(x, x);
            ctx.moveTo(-x, x);
            ctx.lineTo(x, -x);
        },
        switch: function(){
            ctx.rect(-1, -1, 1.8, 2);
            ctx.fillStyle="white";
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(-1, 0);
            ctx.lineTo(0.6, 1);
        },
        power: function(){
            ctx.rect(-0.15, -0.5, 0.3, 1);
            ctx.fillStyle="white";
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(-0.15, 0.5);
            ctx.lineTo(-0.15, -0.5);
            ctx.moveTo(0.15, 1);
            ctx.lineTo(0.15, -1);
        }
    };
    func[type]();
    ctx.stroke();
}
$(function(){
    const c=" width= '"+square+"' height= '"+square+"'";
    for(var i=0;i<=n;i++){
        for(var j=0;j<n;j++){
            $("div.container").append("<canvas class='square board'"+c+"></canvas>");
            $("div.main").append("<div class='line'></div>");
            if(j==0) $("#A :last, #B :last, #C :last, #D :last").css("clear","both");
        }
    }
    for(var i=0;i<m;i++){
        $("div.menu").append("<canvas class='square side'"+c+"></canvas>");
        if(i==0){
            $(".menu canvas:first").addClass("selected");
        }
    }
    $(".square, .line").addClass("outline");
    $("div.menu").width(menu);
    $("div.container, div.main").css("padding","60px "+square/2+"px");
    $("div.outside").width(menu+side*(n+1)).css("left",menu);
    $("canvas.board").css("margin",(side-square)/2);
    $("div.line").width(side).css("margin-bottom",side);
    $("div.container").css("top",-side/2);
    $("#D").css("top",-side/2).css("left",-side/2);
    const table=["line","power","switch","bulb"];
    for(var x in table){
        paint(($(".menu canvas").eq(x))[0], table[x]);
    }
    $(window).contextmenu(function(e){
        e.preventDefault();
    });
    $("canvas.board").click(function(){
        $(".line").eq($(".board").index(this)).addClass("black");
        $(this).text(mode);
        if(mode!=0){
            var data=$(".side")[mode].getContext("2d").getImageData(0,0,square,square);
            this.getContext("2d").putImageData(data,0,0);
        }
    });
    $("canvas.board").contextmenu(function(e){
        if(Number($(this).text())>0){
            this.width=this.width;
            $(this).text("0");
        }
        else{
            var l=$(".line").eq($(".board").index(this));
            l.toggleClass("black");
            if(l.hasClass("black"))
                $(this).text("0");
            else
                $(this).text("");
        }
    });
    $("canvas.side").click(function(){
        $(".side").eq(mode).removeClass("selected");
        $(this).addClass("selected");
        mode=$(".side").index(this);
    });
    $(window).keyup(function(e){
        if(e.key==" "){
            $(".menu").toggle();
            $(".square").toggleClass("outline");
            $(".line:not(.black)").toggleClass("outline");
        }
        else if(e.key=="`")
            $(".side:first").click();
        else{
            var x=Number(e.key);
            if(x<=0 || x>=m) return;
            $(".side").eq(x).click();
        }
    });
    var data=localStorage.getItem("data");
    if(data) decodeCKT(data);
});
$(window).unload(function(){
    localStorage.setItem("data",encodeCKT());
});

</script>
<style>

* {
    margin: 0;
}
div.container, div.main {
    position: absolute;
    pointer-events: none;
}
div.vertical {
    rotate: 90deg;
}
canvas.square {
    display: block;
    position: relative;
    pointer-events: auto;
    z-index: 2;
}
canvas.outline {
    outline: grey dashed 1px;
}
canvas.board {
    float: left;
}
div.line {
    position: relative;
    float: left;
}
div.outline {
    outline: 1px #ccc solid;
}
div.menu {
    position: fixed;
    padding-top: 50px;
}
div.outside {
    position: fixed;
}
canvas.side {
    margin: 30px auto;
}
div.black {
    outline-color: black;
    z-index: 1;
}
canvas.selected {
    outline: red solid 1px;
}

</style>

</head>
<body>

<div class="menu"></div>
<div class="outside">
<div class="main" id="C"></div>
<div class="main vertical" id="D"></div>
<div class="container" id="A"></div>
<div class="container vertical" id="B"></div>
</div>

</body>
</html>